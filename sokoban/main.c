#include "../ass.h"
IBios* interface;

extern const uint16_t tilesTiles[256];
extern const uint16_t tilesPal[16];

#define WIDTH 40
#define HEIGHT 30


#define KEY_UP 0xC8
#define KEY_LEFT 0xCB
#define KEY_RIGHT 0xCD
#define KEY_DOWN 0xD0

#define SPACE 0
#define BOX 1
#define GOAL 2
#define BOXINGOAL 3
#define WALL 4

#define BOUNDS 30

const char * const levels[] = {
	"4-3#|4-#.#|4-#-#|4-#-#|5#$5#|#.--$@$--.#|5#$5#|4-#-#|4-#-#|4-#.#|4-3#",
	"20#|#@$.#.$11-.#|##-3#$8#-#-##|-#-#.$-#-4.-#3-##|-#-#3-#-4$-3#$##|-#-#-#.#7-.#-##|-#-#-3#6-$##-##|-#-#-##7-$.#-##|-#-#-#.-#5-$##-##|-#-#-#$-#6-.#--#|-#-#-#-#--8#-#|-#-#-#-.#-#4-#.$-#|-#-#-#-$#3-#--#.$-#|-#-#-#--##$#-$##.$-#|-#-#-$-.#.4-.#.$-#|-#-15#-#|-#$--$-$8-..-#|-#.#15-#|-19#",
	"14#-4#|#5-.3#--##-#*.#|#5-$#.$$-.#-#-$#|#.##--.##.$-.#-#--#|#5-$-#4-3#--##|##$16-#|#7-#4-#5-#|#-7#$8#-#|#-..$3-$@5-$.#-#|#-3#3-#$8#-#|#-7#-#8-#|#5-#3-#-$.#--$-#|#-$-$-#-#-##-#5-#|#--$--#3-.#5-3#|#-$-$-6#4-##|#5-5.#.-3#|15#",
	"-3#12-4#|-#-14#--#|-#@$.14-#|-#$#-#$11#.#|-#-#-#-13#|-#-#-#-#9-..#|-#-#-#-#-4#-6#|-#-#-#-#7-$3-#|-#-#-#-6#-4#-#|-#-#-#-#--$8-#|-#-#-#-#-4#-6#|-#-#-#-#11-#|-#-#$#-10#--#|-#-#3-.#5.--#--#|##-#-#--#5$#3-$#|#--#-##-#5.--#--#|#4-.#-#5$#-#--#|7#9-$..#|6-14#",
	"20#|#-3.11-3.#|#-$--#-$-$-$7-#|#--$-#13-#|#3-$#-13#|#4-#-#3-#-#3-#-#|#-4#-#-#-#-$-$-$-#|#4-#-#-#-#-.-.-.-#|4#-#3-#-#-#-.-.-#|4#-5#-#-#-#-.-#|#.6-.#-#-#-#-#-#|#3-$4-#-#3-#-#-#|#-##-##--#-#5-#-#|#-##-##--#-#7-#|#$--$--$-#-#7-#|#-##-##--#-#-$-$-$-#|#-##-##--#-##-#-4#|#.--@3-.#9-#|20#",
	"--4#--4#|3#--4#--3#|#12-#|#-.8-.-#|#.#$6#$#.#|#-$3-.4-$-#|#-#3-$--$-#-#|#-#-.$@$..-#-#|#-#3-$4-#-#|#-$3-.4-$-#|#.#$6#$#.#|#-.8-.-#|#12-#|3#--4#--3#|--4#--4#",
	"19#|#17-#|#--6#.--4#--#|#--#.4-#4-.#--#|#--#11-#--#|#--#--3#-3#--#--#|#--#--#--$--#--#--#|#5-#-$-$-#5-#|#--.#--$-@-$--#.--#|#--##-#-$-$-#-##--#|#--#--#--$--#--#--#|#--#--3#-3#--#--#|#--#11-#--#|#--#.4-#4-.#--#|#--4#--.6#--#|#17-#|19#",
	"--3#4-3#|-##-6#-##|##-#6-#-##|#-#--$3-$-#-##|##--$-3#-$-#-#|-#-$--3.--$-##|-#4-3.-#--#|-#--#-3.4-#|##-$--.+.--$-#|#-#-$-3#-$--##|##-#-$3-$--#-#|-##-#6-#-##|--##-6#-##|3-3#4-3#",
	"3-8#|3-#6-#|--##-4#-#|--#.-.#.#-#|4#3$3-#|#--.$@$.3#|#-##3$3-#|#-#.-.-.#-#|#4-#-##-#|6#4-#|5-6#",
	"-14#|-#12-#|-#--8#--#|-#--#.4-.#--#|##-.#-$-*--#.-#|#@--*--*-$-$--#|##--#-*-$--#--#|-#--#--*-$-#--#|-#--#-$-*--#--#|-#--#--$-*-#--#|-#--#-$-*--#--#|-#-.#.4-.#.-#|-#--8#--#|-4#6-4#",
	"20#|#.#8-#--#4-#|#-##--#4-#7-#|#-#5-#-##-#-#3-#|#-#--#3-#-#5-#-#|#-#4-#3-#-3#-#-#|#-#--#3-#-#-#3-#-#|#-#-#6-#-#-#-3#|#-#4-#3-#-#5-#|#-#--#3-#5-#3-#|#-#-#6-#-#-##--#|#-#3-##-#-#-#5-#|#-#4-#5-#-#3-#|#-#-#-#4-#-3#-#-#|#-#6-#5-#3-#|#-#--5#-#--##-$-#|#4-#5-#--##3-#|#4-#-#-#-5#-@-#|20#",
	"-10#|-#-$5-.#|-#-##-14#|-#-#.5-#8-#|-#-#--#3-#4-#-#-#|-#-#--#3-#3-$#.#-#|-#.$--#3-#4-#-#-#|-#-#--#8-#-#-#|##-#--#-6#-#-#-#|#--#--#10-#-#|#--#--#-$@$--#-#-#-#|##.$--#6-#3-#-#|##-#--#6-##-$#-#|#--#--6#-#3-#-#|#.*-$-#3-#5-#--#|##-#.8-#-.$--#|-#--5#-##-3#-.##|-##7-4#-4#|--9#",
	"4-4#|4-#-.#|--3#$-##|--#5-#|--#-$#.-#|--#-.-$-#|--#-$#.-#|3#-.-$-3#|#-$-$@.-$-#|#.--.-$--.#|3#-$#.-3#|--#-.-$-#|--#-$#.-#|--#-.-$-#|--7#",
	"-17#|-#7-.7-#|-#-4#-$-$-4#-#|-#$4#-3#-4#$#|-#-4#-3#-4#-#|##-3#7-3#-##|#6-.-#-.6-#|#--3#--$-$--3#--#|#--3#-#-@-#-3#--#|#7-$-$7-#|##-3#-.-#-.-3#-##|-#-3#7-3#-#|-#-4#-#-#-4#-#|-#$4#-#-#-4#$#|-#-4#5-4#-#|-#5-5.5-#|-17#",
	"20#|#..#-#3-#3-#4-.#|#..$-#-#-#9-#|#-$#-#-#-4#-##-#-#|##-$-$--$##-#-##-#$#|#3-.#3-##3-#.3-#|#-4#--$@-$--4#-#|#3-.#3-##--##.3-#|#$#-##-#-##$--$-$-##|#-#-##-4#-#-#-#$-#|#9-#-#-#-$..#|#.4-#3-#3-#-#..#|20#",
	"4-5#--4#|4-#3-4#--4#|4-#-.--$3-.3-#|4-#--#.4#--#-#|4-##-#-.3#.##-#|5-#$#--.##4-#|5-#-#3$.#$-#-#|5-#-#--$-.-#--#|5-#-##@3$.--##|--4#-##3-$-.##|-##--#-##-#.3$#|##5-##-##.--#|#3-#$7-.-#|#--.--8#.#|7#6-3#",
	"-19#|##.$3-$9-..#|#.--$3-9#--#|##-3#-#.9#-#|#--#5-9#-#|#-##$3#-9#-#|#-##-3#5-.4#-#|#4-#.#$#-##-4#-#|##-#.-$4-##-$-##-#|##--##-3#-#.-$-##-#|#.#8-##.$--$.#|#-4#$$-#3-.##-#-#|#$##5-#-##4-#-#|#.3-.-.##-7#-#|#-#-#-#-##-5#-$-#|#-$4-.##-5#-#-#|#$#$#-4#9-#|#@$--.$.12#|9#",
	"20#|#.#..3-$3-$6-#|#.#-#5-3#-4#-#|#-3#--#9-#-#|#-#.#--##-3#-##$#$#|#-#-#3-#--#3-#-#-#|#6-#4-#6-#|#$#-#--.#--#-#-#-#-#|#-#-#-#$#-##-.-#-#-#|#-#$#-#--@.#3-#-#-#|#-#-##--4#3-3#$#|#-#-#-#-.--#3-#.#-#|#3-$3-$--.#$5-#|#-#-#4-#5-#-#-#|#$#-##-6#-##$#-#|#-#-.4-$7-#-#|#-4#-6#-4#.#|#7-$8-..#|20#",
	"5-9#|4-##-#-#3-#|3-##-#-#-#--##|--##-#5-$-.#|-##-#--$-$--#-#|##--..#-$-#-$-#|#--3.--@#--#-#|##--.3#$-#-$-#|#-#-#--$-$--#.#|##-#.$3-#3-##|-3#.4$-3$#|3-#-4.#3.#|3-11#",
	"--9#|--#.##.##.#|3#$##$##$3#|#.$.--.--.$.#|3#-#3-#-3#|3#--3$--3#|#.$.#$@$#.$.#|3#--3$--3#|3#-#3-#-3#|#.$.--.--.$.#|3#$##$##$3#|--#.##.##.#|--9#",
	"3#3-6#4-4#|#-5#-..-6#..#|#-#3.#--$-#.-$-#-.#|#5-.$-.6-#-$#|#$#--##--$-#$3-#--#|#-#3-3#-##4-#--#|#-#.#4-$--$-$-#$-#|#-#4-##-##4-#--#|#-#3-#.--.##3-#$-#|#.##-##--@-3#-##--#|#3-$4-.4-$4-#|#-##-3#3-3#-##--#|#6-#$-$#4-#--#|#-#-$--#-$-#3-.#--#|#-#..$-#$-$#3-$3-#|#-#-$.-#3-#.-$.#--#|#-6#.-.6#-$#|#3-$4-.8-.#|20#",
	"6-14#|-6#--#.$.$.$.$-#|-#.$.-$--#.$.$.$.$-#|-#4-#3-#-.$.$.$-#|-#.$.$#3-##.$.$.$-#|-#$.$.--4#--.$.$-#|-#--#-#-4#-#.$.$-#|7#-##3-##-.$-#|#-.4#9-.$-#|#.$-13#--#|#$3-13#-#|#.$.--5#8-#|#$.$.--4#-8#|#.-.$.--#4-$-..3#|#$.$.$.3-#-3#$..##|#.$.$.$.-##3-#-$.##|#$-$-$-$6-#-$$##|#.5-$-@9-#|20#",
	"5-12#|6#10-#|#3-$4-$..3#-#|#-$-5#$..--#-#|#3-$--$--..4-#|5#-4#-3#-##|-3#--.$7.#|-#3-#-#$$#$#--#|-#-#$#--$-@--$-#|-#3-#-#-#-##--#|4#-#-#$#-3#$#|4#-#$#.#-3#-#|#.-$-#-##-$-##-#|#.3-.--$5-.#|16#",
	"7-4#|8#.-10#|#-$14-$-#|#-.--#5-#5-.-#|#--5#-5#-##--#|#--5#-5#-##--#|#--5#$5#-3#-#|#--5#-5#-##--#|#--5#-3#3-##--#|#.3-$4-##-#-##--#|#--6#@--$5-.#|#--5#--#-##-##--#|#--5#-$--##-##--#|#--6#-#4-3#-#|#--6#-4#-##--#|#-.3-#5-#4-.-#|#-$14-$-#|9#.-9#|8-4#",
	"20#|#..6-$6-$..#|##-7#-6#-##|#-$-#3-#3-#3-#--#|#-$7-$8-#|#--.#3-#3-#3-#--#|##-14#-$#|#4-$.$.--$.$.--$.#|#3-$.-$.-$.-$.-$.-#|#--$.--$.$.--$.$.--#|##-15#-#|#-$-.-.-.-.-.-..-.-#|#-13$.--.#|#--.-.$.-.-.-.-.3-#|#-15#$##|#--.#--.#--.#--.#--#|#-$$-.$$-.$$-.$$-.-#|#@--#3-#3-#3-#--#|20#",
	"20#|#.$15-.#|#--7#-5#-#$#|#-#.$11-.#-#|#-#-12#$#-#|#-#-#.$7-.#-#-#|#-#-#-#.#-#-##$#-#-#|#-#-#-#-#3-##-#-#-#|#-#-#-#-6#-#-#-#|#5-#-5#--#3-#|#-#-#-#$6-.#-#-#|#-#-#3-8#-#-#|#-#-#-#.7-$-#-#|#3-#$10#-#-#|#-#--.9-$.--#|#-#$14#-#|#$#.13-$.#|#@#16-#|20#",
	"18#|#16-#|#4-$-$4.$-$--#|#-#14-#|#-#--10#--#|#-#--.8-.--#|#-#-3#$3#$4#-#|#-#..3-$-$4-..#|#-3#-3#-9#|#-$--.--$@$--.--$-#|#-7#-3#-3#-#|#-#15-#|#-#-9#-##-##|#11-$.$.-#|#3-$.$.$.$.$.$.##|#-#$.$.$.$.$.$.$.#|#3-14#|5#",
	"20#|#--$10-..#-.#|#4-#-7#--#-$#|#--@-#.8-$#--#|##-#-#-#--$-$3.#.-#|##$#-#-#$5#-$#-##|##-#-#-#.4-$-.#$.#|##-#-#$#-#-$-3.#-.#|##-#-#-#$#-6#$$#|#4-#-#-#$#7-#|#-##-#-#-#-#7-#|#-.#-#3-#-#-4#.-#|#--#-#-$.#-#-4#$-#|#--#-#5-#-4#--#|#-$#-7#-4#--#|#12-4#--#|#.$-#12-.-#|#5-$5-.6-#|20#",
	"19#|#3.$..--.3-##3-#|#-#-.-$-.-##-##--$#|#-$$#$.--$##-##-$.#|#5-#3-##-##-#-#|#-6$-@6-$.#|#5-#3-##6-#|#-$-#-.--$##$-#-$.#|#-#$.$$-.-##-$#-#-#|#3.$..--.##$.#-$.#|#-6#-3#.-3#.#|#-$7-##$.--#-#|##-#-#-#3-#.$#-#-#|-#-#.#-#-#-#-.--#-#|-#-#-#-#-#-#-4#-#|-#-$-$-$-$4-4.#|-3#--13#|3-4#",
	"3-5#|--##3-##|--#..-..#|3#$-$-$3#|#3-.-.3-#|#-##-#-##-#|#3-$-$3-#|#-#$-.-$#-#|#--.$#$.--#|4#3-4#|3-##@##|4-3#",
	"20#|#5-#.##--##4-.#|#$6-##-$##--4#|#5-#-##--3#$3#|#.4-#5-$5-#|##-4#-##-.#.--$-#|-#.4#4-8#|##-7#$4#--#|#-$-3#.$.--3#-$#|#@-$-.4-.-3#--#|##$6#$5#--#|-#-#3-##-.4#-.#|##.#-#-##--4#$4#|#.-#7-$6-##|#$-3#-##-$##.--$--#|#--#.--##--4#-4#|#--#$#--3#3-$--.##|#--#.3-3#3-#.3#|17#",
	"13#|#11-#|#11-#|#--7.--#|#--7$--#|#--$5.$--#|#--$.3$.$--#|#-.$.$@$.$.-#|#--$.3$.$--#|#--$5.$--#|#--7$--#|#--7.--#|#11-#|#11-#|13#",
	"11#|#.3-.-.-.#|#4-#4-#|#-$-$#$-$-#|#4-#4-#|#.3#@3#.#|#3-$-$3-#|#-$--#--$-#|#--$-#-$--#|#.-.-.3-.#|11#",
	"19#|#.6-.#.#.--#..#|#--#$#$#-#-#.$.#--#|#.$-.$--.#8-#|#--#-#-#-#$#$#$#$-#|#3-$--#5-#4-#|4#-11#-$#|3-#14-#|9#@7#-#|#.8-#-$.#.$-#|#-3#4$3-#-#-#-#|#9-#.$-$-$.#|#..3#3$-3#-#-#-#|#9-#.$-.-$.#|#.-.3#$$3-#-#-#-#|#9-#-$.-.$-#|#4.3#--9#|11#",
	"20#|#16-$.#|#-#-16#|#-#--.13-#|#-#-#-14#|#-#-#.-.9-$-#|#-#-#-#-10#-#|#-#-#-#.-.7-$-#|#-#-#-#-#-8#-#|#-#-#-#-#.7-$-#|#-#-#-#-#-#-6#-#|#-#-#-#-#-#-$5-.#|#-#$#$#$#$#-6#-#|#-#.#14-#|#-9#-8#|#.3-.-$4-$--$--##|3#-#-5#7-##|#@--#-$--.#.8#|20#",
	"6-7#6-|4-3#5-#6-|4-#--$3#-#6-|4-#$--3#-#6-|--3#5-$-#6-|--#--$-$-##-#6-|3#-#-##-##-7#|#3-#-##-##-##.$..#|#-$--$4-$-.*4.#|5#-3#-#@##-$..#|4-#5-#-##-4#|4-7#4-#3-|10-6#3-",
	"11-4#|12#-@5#|#17-#|#-$3-.#5-$-#-.#|#-$3-.#5-$3-.#|#-$3-#.5-$-#-.#|#-$3-#.5-$-#-.#|#4-#--6#-#--#|#4-#--#6-#--#|#3-#3-#6-#--#|#3-#3-#6-#--#|#-$#3-.#6-#--#|#--#$--.#3-##-#--#|#-#--$-.--##3-#--#|#-#$3-.##3-$-#-.#|#5-##5-$3-.#|#3-##-$3-#-$-#-.#|#.##7-#-$3-.#|19#",
};

int levelNum = 0;

char map[BOUNDS*BOUNDS] = {0};
uint16_t playerX = 0, playerY = 0;

void move(char byX, char byY)
{
	char *under = &map[(playerY * BOUNDS) + playerX];
	char *here = &map[((playerY + byY) * BOUNDS) + playerX + byX];
	if (*here == WALL)
		return;
	else if (*here & BOX)
	{
		//We might be able to push this!
		char *further = &map[((playerY + byY + byY) * BOUNDS) + playerX + byX + byX];
		if ((*further != WALL) && !(*further & BOX))
		{
			MAP1[(playerY * 64) + playerX] = *under;
			*further |= BOX;
			*here &= ~BOX;
			playerX += byX;
			playerY += byY;
			MAP1[((playerY + byY) * 64) + playerX + byX] = *further;
			MAP1[(playerY * 64) + playerX] = 5;
		}
	}
	else
	{
		MAP1[(playerY * 64) + playerX] = *under;
		playerX += byX;
		playerY += byY;
		MAP1[(playerY * 64) + playerX] = 5;
	}
}

void draw()
{
	char* here = map;
	REG_INTRMODE |= 0x80;
	for (int j = 0; j < BOUNDS; j++)
	{
		for (int i = 0; i < BOUNDS; i++)
		{
			MAP1[(j * 64) + i] = *here++;
		}
	}
	MAP1[(playerY * 64) + playerX] = 5;
}

void clearLevel()
{
	for (int i = 0; i < BOUNDS * BOUNDS; i++)
		map[i] = 0;
}

void loadFromCode(const char* source)
{
	clearLevel();
	char ch = *source;
	int wasDigit = 0;
	int row = 0, col = 0;
	int len = 1;
	int type = -1;
	while ((ch = *source++))
	{
		REG_DEBUGOUT = ch;
		type = -1;
		switch (ch)
		{
			case '0':
			case '1':
			case '2':
			case '3':
			case '4':
			case '5':
			case '6':
			case '7':
			case '8':
			case '9':
				if (!wasDigit)
					len = 0;
				len = (len * 10) + (ch - '0');
				wasDigit = 1;
				break;
			case '|':
				wasDigit = 0;
				len = 1;
				row++;
				col = 0;
				break;
			case ' ':
			case '_':
			case '-':
				type = SPACE;
				break;
			case '$':
				type = BOX;
				break;
			case '.':
				type = GOAL;
				break;
			case '*':
				type = BOXINGOAL;
				break;
			case '#':
				type = WALL;
				break;
			case '@':
				type = SPACE;
				playerX = row;
				playerY = col;
				break;
		}
		if (type != -1)
		{
			while (len > 0)
			{
				map[(row * BOUNDS) + col] = type;
				col++;
				len--;
			}
			len = 1;
			wasDigit = 0;
		}
	}
}

void load(const char* source)
{
	clearLevel();
	char* here = map;
	int k = 0;
	for (int j = 0; j < BOUNDS; j++)
	{
		for (int i = 0; i < BOUNDS; i++)
		{
			switch (source[k++])
			{
				case ' ': *here++ = SPACE; break;
				case '$': *here++ = BOX; break;
				case '.': *here++ = GOAL; break;
				case '*': *here++ = BOXINGOAL;  break;
				case '#': *here++ = WALL; break;
				case '@':
					*here++ = SPACE;
					playerX = i;
					playerY = j;
					break;
				case 0: return;
			}
		}
	}
}

int checkWin()
{
	for (int i = 0; i < BOUNDS * BOUNDS; i++)
	{
		if (map[i] == GOAL)
		{
			return 0;
		}
	}
	return 1;
}

void WaitForKey()
{
	while (REG_KEYIN != 0) { vbl(); }
	while (REG_KEYIN == 0) { vbl(); }
	while (REG_KEYIN != 0) { vbl(); }
}

int main(void)
{
	interface = (IBios*)(0x01000000);
	MISC->SetTextMode(SMODE_TILE | SMODE_320 | SMODE_240);
	MISC->DmaCopy(PALETTE, (int8_t*)&tilesPal, 16, DMA_INT);
	MISC->DmaCopy((int8_t*)0x0E080000, (int8_t*)&tilesTiles, 1024, DMA_INT);
	MISC->DmaClear(MAP1, 0, WIDTH * HEIGHT, 2);
	REG_MAPSET1 = 0x80;
	REG_INTRMODE |= 0x80;
	clearLevel();
	levelNum = 0;
	loadFromCode(levels[levelNum]);
	draw();
	DRAW->FadeFromBlack();

	for(;;)
	{
		int in = REG_KEYIN;
		while (REG_KEYIN != 0) { vbl(); }
		switch (in)
		{
			case KEY_LEFT: move(-1, 0); break;
			case KEY_RIGHT: move(1, 0); break;
			case KEY_UP: move(0, -1); break;
			case KEY_DOWN: move(0, 1); break;
		}
		if (checkWin())
		{
			DRAW->FadeToWhite();
			levelNum++;
			loadFromCode(levels[levelNum]);
			draw();
			DRAW->FadeFromWhite();
		}
	}
}
