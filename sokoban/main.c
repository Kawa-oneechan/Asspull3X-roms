#include "../ass.h"
IBios* interface;

extern const uint16_t tilesTiles[], tilesPal[];
extern const uint16_t playerTiles[], playerPal[];
extern const uint16_t hdma1[];

#define WIDTH 40
#define HEIGHT 30

#define KEY_UP 0xC8
#define KEY_LEFT 0xCB
#define KEY_RIGHT 0xCD
#define KEY_DOWN 0xD0

#define SPRITEA_BUILD(t,e,p)	\
(								\
	(((p) & 15) << 12) |		\
	(((e) &  1) << 11) |		\
	(((t) & 0x1FF) << 0)		\
)
#define SPRITEB_BUILD(hp,vp,dw,dh,hf,vf,ds,pr)	\
(												\
	(((pr) & 3) << 30) |						\
	(((ds) & 1) << 28) |						\
	(((vf) & 1) << 27) |						\
	(((hf) & 1) << 26) |						\
	(((dh) & 1) << 25) |						\
	(((dw) & 1) << 24) |						\
	(((vp) & 0x7FF) << 12) |					\
	(((hp) & 0x7FF) << 0)						\
)

#define SPACE 0
#define BOX 1
#define GOAL 2
#define BOXINGOAL 3
#define WALL 4
#define WALLALT 5
#define EXTERIOR 6

#define BOUNDS 30

#define ANIMSPEED 32

const char * const levels[] = {
	"||8x3#|8x#.#|8x#-#|8x#-#|4x5#$5#|4x#.--$@$--.#|4x5#$5#|8x#-#|8x#-#|8x#.#|8x3#",
	"20#|#@$.#.$11-.#|##-3#$8#-#-##|x#-#.$-#-4.-#3-##|x#-#3-#-4$-3#$##|x#-#-#.#7-.#-##|x#-#-3#6-$##-##|x#-#-##7-$.#-##|x#-#-#.-#5-$##-##|x#-#-#$-#6-.#--#|x#-#-#-#--8#-#|x#-#-#-.#-#4-#.$-#|x#-#-#-$#3-#--#.$-#|x#-#-#--##$#-$##.$-#|x#-#-$-.#.4-.#.$-#|x#-15#-#|x#$--$-$8-..-#|x#.#15-#|x19#",
	"14#-4#|#5-.3#--##-#*.#|#5-$#.$$-.#-#-$#|#.##--.##.$-.#-#--#|#5-$-#4-3#--##|##$16-#|#7-#4-#5-#|#-7#$8#-#|#-..$3-$@5-$.#-#|#-3#3-#$8#-#|#-7#-#8-#|#5-#3-#-$.#--$-#|#-$-$-#-#-##-#5-#|#--$--#3-.#5-3#|#-$-$-6#4-##|#5-5.#.-3#|15#",
	"-3#12-4#|x#-14#--#|x#@$.14-#|x#$#-#$11#.#|x#-#-#-13#|x#-#-#-#9-..#|x#-#-#-#-4#-6#|x#-#-#-#7-$3-#|x#-#-#-6#-4#-#|x#-#-#-#--$8-#|x#-#-#-#-4#-6#|x#-#-#-#11-#|x#-#$#-10#--#|x#-#3-.#5.--#--#|##-#-#--#5$#3-$#|#--#-##-#5.--#--#|#4-.#-#5$#-#--#|7#9-$..#|6-14#",
	"20#|#-3.11-3.#|#-$--#-$-$-$7-#|#--$-#13-#|#3-$#-13#|#4-#-#3-#-#3-#-#|#-4#-#-#-#-$-$-$-#|#4-#-#-#-#-.-.-.-#|4#-#3-#-#-#-.-.-#|4#-5#-#-#-#-.-#|#.6-.#-#-#-#-#-#|#3-$4-#-#3-#-#-#|#-##-##--#-#5-#-#|#-##-##--#-#7-#|#$--$--$-#-#7-#|#-##-##--#-#-$-$-$-#|#-##-##--#-##-#-4#|#.--@3-.#9-#|20#",
	"--4#--4#|3#--4#--3#|#12-#|#-.8-.-#|#.#$6#$#.#|#-$3-.4-$-#|#-#3-$--$-#-#|#-#-.$@$..-#-#|#-#3-$4-#-#|#-$3-.4-$-#|#.#$6#$#.#|#-.8-.-#|#12-#|3#--4#--3#|x-4#--4#",
	"19#|#17-#|#--6#.--4#--#|#--#.4-#4-.#--#|#--#11-#--#|#--#--3#-3#--#--#|#--#--#--$--#--#--#|#5-#-$-$-#5-#|#--.#--$-@-$--#.--#|#--##-#-$-$-#-##--#|#--#--#--$--#--#--#|#--#--3#-3#--#--#|#--#11-#--#|#--#.4-#4-.#--#|#--4#--.6#--#|#17-#|19#",
	"--3#4-3#|x##-6#-##|##-#6-#-##|#-#--$3-$-#-##|##--$-3#-$-#-#|x#-$--3.--$-##|x#4-3.-#--#|x#--#-3.4-#|##-$--.+.--$-#|#-#-$-3#-$--##|##-#-$3-$--#-#|x##-#6-#-##|x-##-6#-##|3-3#4-3#",
	"3-8#|3-#6-#|x-##-4#-#|x-#.-.#.#-#|4#3$3-#|#--.$@$.3#|#-##3$3-#|#-#.-.-.#-#|#4-#-##-#|6#4-#|5-6#",
	"-14#|x#12-#|x#--8#--#|x#--#.4-.#--#|##-.#-$-*--#.-#|#@--*--*-$-$--#|##--#-*-$--#--#|x#--#--*-$-#--#|x#--#-$-*--#--#|x#--#--$-*-#--#|x#--#-$-*--#--#|x#-.#.4-.#.-#|x#--8#--#|x4#6-4#",
	"20#|#.#8-#--#4-#|#-##--#4-#7-#|#-#5-#-##-#-#3-#|#-#--#3-#-#5-#-#|#-#4-#3-#-3#-#-#|#-#--#3-#-#-#3-#-#|#-#-#6-#-#-#-3#|#-#4-#3-#-#5-#|#-#--#3-#5-#3-#|#-#-#6-#-#-##--#|#-#3-##-#-#-#5-#|#-#4-#5-#-#3-#|#-#-#-#4-#-3#-#-#|#-#6-#5-#3-#|#-#--5#-#--##-$-#|#4-#5-#--##3-#|#4-#-#-#-5#-@-#|20#",
	"-10#|x#-$5-.#|x#-##-14#|x#-#.5-#8-#|x#-#--#3-#4-#-#-#|x#-#--#3-#3-$#.#-#|x#.$--#3-#4-#-#-#|x#-#--#8-#-#-#|##-#--#-6#-#-#-#|#--#--#10-#-#|#--#--#-$@$--#-#-#-#|##.$--#6-#3-#-#|##-#--#6-##-$#-#|#--#--6#-#3-#-#|#.*-$-#3-#5-#--#|##-#.8-#-.$--#|x#--5#-##-3#-.##|x##7-4#-4#|x-9#",
	"4-4#|4-#-.#|x-3#$-##|x-#5-#|x-#-$#.-#|x-#-.-$-#|x-#-$#.-#|3#-.-$-3#|#-$-$@.-$-#|#.--.-$--.#|3#-$#.-3#|x-#-.-$-#|x-#-$#.-#|x-#-.-$-#|x-7#",
	"-17#|x#7-.7-#|x#-4#-$-$-4#-#|x#$4#-3#-4#$#|x#-4#-3#-4#-#|##-3#7-3#-##|#6-.-#-.6-#|#--3#--$-$--3#--#|#--3#-#-@-#-3#--#|#7-$-$7-#|##-3#-.-#-.-3#-##|x#-3#7-3#-#|x#-4#-#-#-4#-#|x#$4#-#-#-4#$#|x#-4#5-4#-#|x#5-5.5-#|x17#",
	"20#|#..#-#3-#3-#4-.#|#..$-#-#-#9-#|#-$#-#-#-4#-##-#-#|##-$-$--$##-#-##-#$#|#3-.#3-##3-#.3-#|#-4#--$@-$--4#-#|#3-.#3-##--##.3-#|#$#-##-#-##$--$-$-##|#-#-##-4#-#-#-#$-#|#9-#-#-#-$..#|#.4-#3-#3-#-#..#|20#",
	"4-5#--4#|4-#3-4#--4#|4-#-.--$3-.3-#|4-#--#.4#--#-#|4-##-#-.3#.##-#|5-#$#--.##4-#|5-#-#3$.#$-#-#|5-#-#--$-.-#--#|5-#-##@3$.--##|x-4#-##3-$-.##|x##--#-##-#.3$#|##5-##-##.--#|#3-#$7-.-#|#--.--8#.#|7#6-3#",
	"-19#|##.$3-$9-..#|#.--$3-9#--#|##-3#-#.9#-#|#--#5-9#-#|#-##$3#-9#-#|#-##-3#5-.4#-#|#4-#.#$#-##-4#-#|##-#.-$4-##-$-##-#|##--##-3#-#.-$-##-#|#.#8-##.$--$.#|#-4#$$-#3-.##-#-#|#$##5-#-##4-#-#|#.3-.-.##-7#-#|#-#-#-#-##-5#-$-#|#-$4-.##-5#-#-#|#$#$#-4#9-#|#@$--.$.12#|9#",
	"20#|#.#..3-$3-$6-#|#.#-#5-3#-4#-#|#-3#--#9-#-#|#-#.#--##-3#-##$#$#|#-#-#3-#--#3-#-#-#|#6-#4-#6-#|#$#-#--.#--#-#-#-#-#|#-#-#-#$#-##-.-#-#-#|#-#$#-#--@.#3-#-#-#|#-#-##--4#3-3#$#|#-#-#-#-.--#3-#.#-#|#3-$3-$--.#$5-#|#-#-#4-#5-#-#-#|#$#-##-6#-##$#-#|#-#-.4-$7-#-#|#-4#-6#-4#.#|#7-$8-..#|20#",
	"5-9#|4-##-#-#3-#|3-##-#-#-#--##|x-##-#5-$-.#|x##-#--$-$--#-#|##--..#-$-#-$-#|#--3.--@#--#-#|##--.3#$-#-$-#|#-#-#--$-$--#.#|##-#.$3-#3-##|x3#.4$-3$#|3-#-4.#3.#|3-11#",
	"--9#|x-#.##.##.#|3#$##$##$3#|#.$.--.--.$.#|3#-#3-#-3#|3#--3$--3#|#.$.#$@$#.$.#|3#--3$--3#|3#-#3-#-3#|#.$.--.--.$.#|3#$##$##$3#|x-#.##.##.#|x-9#",
	"3#3-6#4-4#|#-5#-..-6#..#|#-#3.#--$-#.-$-#-.#|#5-.$-.6-#-$#|#$#--##--$-#$3-#--#|#-#3-3#-##4-#--#|#-#.#4-$--$-$-#$-#|#-#4-##-##4-#--#|#-#3-#.--.##3-#$-#|#.##-##--@-3#-##--#|#3-$4-.4-$4-#|#-##-3#3-3#-##--#|#6-#$-$#4-#--#|#-#-$--#-$-#3-.#--#|#-#..$-#$-$#3-$3-#|#-#-$.-#3-#.-$.#--#|#-6#.-.6#-$#|#3-$4-.8-.#|20#",
	"6-14#|x6#--#.$.$.$.$-#|x#.$.-$--#.$.$.$.$-#|x#4-#3-#-.$.$.$-#|x#.$.$#3-##.$.$.$-#|x#$.$.--4#--.$.$-#|x#--#-#-4#-#.$.$-#|7#-##3-##-.$-#|#-.4#9-.$-#|#.$-13#--#|#$3-13#-#|#.$.--5#8-#|#$.$.--4#-8#|#.-.$.--#4-$-..3#|#$.$.$.3-#-3#$..##|#.$.$.$.-##3-#-$.##|#$-$-$-$6-#-$$##|#.5-$-@9-#|20#",
	"5-12#|6#10-#|#3-$4-$..3#-#|#-$-5#$..--#-#|#3-$--$--..4-#|5#-4#-3#-##|x3#--.$7.#|x#3-#-#$$#$#--#|x#-#$#--$-@--$-#|x#3-#-#-#-##--#|4#-#-#$#-3#$#|4#-#$#.#-3#-#|#.-$-#-##-$-##-#|#.3-.--$5-.#|16#",
	"7-4#|8#.-10#|#-$14-$-#|#-.--#5-#5-.-#|#--5#-5#-##--#|#--5#-5#-##--#|#--5#$5#-3#-#|#--5#-5#-##--#|#--5#-3#3-##--#|#.3-$4-##-#-##--#|#--6#@--$5-.#|#--5#--#-##-##--#|#--5#-$--##-##--#|#--6#-#4-3#-#|#--6#-4#-##--#|#-.3-#5-#4-.-#|#-$14-$-#|9#.-9#|8-4#",
	"20#|#..6-$6-$..#|##-7#-6#-##|#-$-#3-#3-#3-#--#|#-$7-$8-#|#--.#3-#3-#3-#--#|##-14#-$#|#4-$.$.--$.$.--$.#|#3-$.-$.-$.-$.-$.-#|#--$.--$.$.--$.$.--#|##-15#-#|#-$-.-.-.-.-.-..-.-#|#-13$.--.#|#--.-.$.-.-.-.-.3-#|#-15#$##|#--.#--.#--.#--.#--#|#-$$-.$$-.$$-.$$-.-#|#@--#3-#3-#3-#--#|20#",
	"20#|#.$15-.#|#--7#-5#-#$#|#-#.$11-.#-#|#-#-12#$#-#|#-#-#.$7-.#-#-#|#-#-#-#.#-#-##$#-#-#|#-#-#-#-#3-##-#-#-#|#-#-#-#-6#-#-#-#|#5-#-5#--#3-#|#-#-#-#$6-.#-#-#|#-#-#3-8#-#-#|#-#-#-#.7-$-#-#|#3-#$10#-#-#|#-#--.9-$.--#|#-#$14#-#|#$#.13-$.#|#@#16-#|20#",
	"18#|#16-#|#4-$-$4.$-$--#|#-#14-#|#-#--10#--#|#-#--.8-.--#|#-#-3#$3#$4#-#|#-#..3-$-$4-..#|#-3#-3#-9#|#-$--.--$@$--.--$-#|#-7#-3#-3#-#|#-#15-#|#-#-9#-##-##|#11-$.$.-#|#3-$.$.$.$.$.$.##|#-#$.$.$.$.$.$.$.#|#3-14#|5#",
	"20#|#--$10-..#-.#|#4-#-7#--#-$#|#--@-#.8-$#--#|##-#-#-#--$-$3.#.-#|##$#-#-#$5#-$#-##|##-#-#-#.4-$-.#$.#|##-#-#$#-#-$-3.#-.#|##-#-#-#$#-6#$$#|#4-#-#-#$#7-#|#-##-#-#-#-#7-#|#-.#-#3-#-#-4#.-#|#--#-#-$.#-#-4#$-#|#--#-#5-#-4#--#|#-$#-7#-4#--#|#12-4#--#|#.$-#12-.-#|#5-$5-.6-#|20#",
	"19#|#3.$..--.3-##3-#|#-#-.-$-.-##-##--$#|#-$$#$.--$##-##-$.#|#5-#3-##-##-#-#|#-6$-@6-$.#|#5-#3-##6-#|#-$-#-.--$##$-#-$.#|#-#$.$$-.-##-$#-#-#|#3.$..--.##$.#-$.#|#-6#-3#.-3#.#|#-$7-##$.--#-#|##-#-#-#3-#.$#-#-#|x#-#.#-#-#-#-.--#-#|x#-#-#-#-#-#-4#-#|x#-$-$-$-$4-4.#|x3#--13#|3-4#",
	"3-5#|x-##3-##|x-#..-..#|3#$-$-$3#|#3-.-.3-#|#-##-#-##-#|#3-$-$3-#|#-#$-.-$#-#|#--.$#$.--#|4#3-4#|3-##@##|4-3#",
	"20#|#5-#.##--##4-.#|#$6-##-$##--4#|#5-#-##--3#$3#|#.4-#5-$5-#|##-4#-##-.#.--$-#|x#.4#4-8#|##-7#$4#--#|#-$-3#.$.--3#-$#|#@-$-.4-.-3#--#|##$6#$5#--#|x#-#3-##-.4#-.#|##.#-#-##--4#$4#|#.-#7-$6-##|#$-3#-##-$##.--$--#|#--#.--##--4#-4#|#--#$#--3#3-$--.##|#--#.3-3#3-#.3#|17#",
	"13#|#11-#|#11-#|#--7.--#|#--7$--#|#--$5.$--#|#--$.3$.$--#|#-.$.$@$.$.-#|#--$.3$.$--#|#--$5.$--#|#--7$--#|#--7.--#|#11-#|#11-#|13#",
	"11#|#.3-.-.-.#|#4-#4-#|#-$-$#$-$-#|#4-#4-#|#.3#@3#.#|#3-$-$3-#|#-$--#--$-#|#--$-#-$--#|#.-.-.3-.#|11#",
	"19#|#.6-.#.#.--#..#|#--#$#$#-#-#.$.#--#|#.$-.$--.#8-#|#--#-#-#-#$#$#$#$-#|#3-$--#5-#4-#|4#-11#-$#|3-#14-#|9#@7#-#|#.8-#-$.#.$-#|#-3#4$3-#-#-#-#|#9-#.$-$-$.#|#..3#3$-3#-#-#-#|#9-#.$-.-$.#|#.-.3#$$3-#-#-#-#|#9-#-$.-.$-#|#4.3#--9#|11#",
	"20#|#16-$.#|#-#-16#|#-#--.13-#|#-#-#-14#|#-#-#.-.9-$-#|#-#-#-#-10#-#|#-#-#-#.-.7-$-#|#-#-#-#-#-8#-#|#-#-#-#-#.7-$-#|#-#-#-#-#-#-6#-#|#-#-#-#-#-#-$5-.#|#-#$#$#$#$#-6#-#|#-#.#14-#|#-9#-8#|#.3-.-$4-$--$--##|3#-#-5#7-##|#@--#-$--.#.8#|20#",
	"6-7#6-|4-3#5-#6-|4-#--$3#-#6-|4-#$--3#-#6-|x-3#5-$-#6-|x-#--$-$-##-#6-|3#-#-##-##-7#|#3-#-##-##-##.$..#|#-$--$4-$-.*4.#|5#-3#-#@##-$..#|4-#5-#-##-4#|4-7#4-#3-|10-6#3-",
	"11-4#|12#-@5#|#17-#|#-$3-.#5-$-#-.#|#-$3-.#5-$3-.#|#-$3-#.5-$-#-.#|#-$3-#.5-$-#-.#|#4-#--6#-#--#|#4-#--#6-#--#|#3-#3-#6-#--#|#3-#3-#6-#--#|#-$#3-.#6-#--#|#--#$--.#3-##-#--#|#-#--$-.--##3-#--#|#-#$3-.##3-$-#-.#|#5-##5-$3-.#|#3-##-$3-#-$-#-.#|#.##7-#-$3-.#|19#",
};

int levelNum = 0;

char map[BOUNDS*BOUNDS] = {0};
int playerX = 0, playerY = 0;
int lastDir;

int cameraX, cameraY;

void drawPlayer()
{
	int tile = 0;
	int flip = 0;
	switch (lastDir)
	{
		case 0: //left
			break;
		case 1: //right
			flip = 1;
			break;
		case 2: //down
			tile = 16;
			break;
		case 3: //up
			tile = 32;
			break;
	}
	if (REG_TICKCOUNT % ANIMSPEED > (ANIMSPEED / 2))
		tile += 8;

	//these really need to be defined...
	*(uint16_t*)0xE108000 = SPRITEA_BUILD(tile + 256, 1, 0);
	*(uint32_t*)0xE108200 = SPRITEB_BUILD((playerX - cameraX) * 16, (playerY - cameraY - 1) * 16, 0, 1, flip, 0, 1, 1);
}

void drawTile(int i, int j, int tile)
{
	if (tile == WALL && j < BOUNDS)
	{
		if (map[((j + cameraY) * BOUNDS) + BOUNDS + i + cameraX] != WALL)
			tile = WALLALT;
	}
	int pos = (j * 128) + (i * 2);
	MAP1[pos] = 4 + (tile * 4) + 0;
	MAP1[pos + 1] = 4 + (tile * 4) + 1;
	MAP1[pos + 64] = 4 + (tile * 4) + 2;
	MAP1[pos + 65] = 4 + (tile * 4) + 3;
}

void draw()
{
	char* here = map;
	here += cameraY * BOUNDS;
	here += cameraX;
	REG_INTRMODE |= 0x80;
	for (int j = 0; j < BOUNDS; j++)
		for (int i = 0; i < BOUNDS; i++)
			drawTile(i, j, *here++);
	drawPlayer();
}

void focus()
{
	int moved = 0;
	while (playerY - cameraY < 5 && cameraY > 0)
	{
		moved = 1;
		cameraY--;
	}
	while (playerY - cameraY > 10)
	{
		moved = 1;
		cameraY++;
	}
	while (playerX - cameraX < 5 && cameraX > 0)
	{
		moved = 1;
		cameraX--;
	}
	while (playerX - cameraX > 12)
	{
		moved = 1;
		cameraX++;
	}
	if (moved)
		draw();
	drawPlayer(lastDir);
}

void move(char byX, char byY)
{
	char *under = &map[(playerY * BOUNDS) + playerX];
	char *here = &map[((playerY + byY) * BOUNDS) + playerX + byX];
	lastDir = 0;
	if (byX == -1) lastDir = 1;
	else if (byY == 1) lastDir = 2;
	else if (byY == -1) lastDir = 3;
	if (*here == WALL)
		return;
	else if (*here & BOX)
	{
		//We might be able to push this!
		char *further = &map[((playerY + byY + byY) * BOUNDS) + playerX + byX + byX];
		if ((*further != WALL) && !(*further & BOX))
		{
			drawTile(playerX - cameraX + byX, playerY - cameraY + byY, *under);
			*further |= BOX;
			*here &= ~BOX;
			playerX += byX;
			playerY += byY;
			drawTile(playerX - cameraX + byX, playerY - cameraY + byY, *further);
			focus();
		}
	}
	else
	{
		playerX += byX;
		playerY += byY;
		focus();
	}
}

void clearLevel()
{
	for (int i = 0; i < BOUNDS * BOUNDS; i++)
		map[i] = EXTERIOR;
}

void loadFromCode(const char* source)
{
	clearLevel();
	char ch = *source;
	int wasDigit = 0;
	int row = 0, col = 0;
	int len = 1;
	int type = -1;
	while ((ch = *source++))
	{
		REG_DEBUGOUT = ch;
		type = -1;
		switch (ch)
		{
			case '0':
			case '1':
			case '2':
			case '3':
			case '4':
			case '5':
			case '6':
			case '7':
			case '8':
			case '9':
				if (!wasDigit)
					len = 0;
				len = (len * 10) + (ch - '0');
				wasDigit = 1;
				break;
			case '|':
				wasDigit = 0;
				len = 1;
				row++;
				col = 0;
				break;
			case ' ':
			case '_':
			case '-':
				type = SPACE;
				break;
			case '$':
				type = BOX;
				break;
			case '.':
				type = GOAL;
				break;
			case '*':
				type = BOXINGOAL;
				break;
			case '#':
				type = WALL;
				break;
			case 'x':
				type = EXTERIOR;
				break;
			case '@':
				type = SPACE;
				playerX = col;
				playerY = row;
				break;
		}
		if (type != -1)
		{
			while (len > 0)
			{
				map[(row * BOUNDS) + col] = type;
				col++;
				len--;
			}
			len = 1;
			wasDigit = 0;
		}
	}
}

void load(const char* source)
{
	clearLevel();
	char* here = map;
	int k = 0;
	for (int j = 0; j < BOUNDS; j++)
	{
		for (int i = 0; i < BOUNDS; i++)
		{
			switch (source[k++])
			{
				case ' ': *here++ = SPACE; break;
				case '$': *here++ = BOX; break;
				case '.': *here++ = GOAL; break;
				case '*': *here++ = BOXINGOAL;  break;
				case '#': *here++ = WALL; break;
				case '@':
					*here++ = SPACE;
					playerX = i;
					playerY = j;
					break;
				case 0: return;
			}
		}
	}
}

int checkWin()
{
	for (int i = 0; i < BOUNDS * BOUNDS; i++)
	{
		if (map[i] == GOAL)
		{
			return 0;
		}
	}
	return 1;
}

void WaitForKey()
{
	while (REG_KEYIN != 0) { vbl(); }
	while (REG_KEYIN == 0) { vbl(); }
	while (REG_KEYIN != 0) { vbl(); }
}

int main(void)
{
	interface = (IBios*)(0x01000000);
	MISC->SetTextMode(SMODE_TILE | SMODE_SPRITES);
	MISC->DmaCopy((int8_t*)0x0E080000, (int8_t*)&tilesTiles, 1024, DMA_INT);
	MISC->DmaCopy((int8_t*)0x0E082000, (int8_t*)&playerTiles, 1024, DMA_INT);
	MISC->DmaCopy(PALETTE, (int16_t*)&tilesPal, 16, DMA_INT);
	MISC->DmaCopy(PALETTE + 32, (int16_t*)&playerPal, 16, DMA_INT);
	MISC->DmaClear(MAP1, 0, WIDTH * HEIGHT, 2);
	REG_HDMASOURCE[0] = (int32_t)hdma1;
	REG_HDMATARGET[0] = (int32_t)PALETTE;
	REG_HDMACONTROL[0] = DMA_ENABLE | HDMA_DOUBLE | (DMA_SHORT << 4) | (0 << 8) | (480 << 20);
	REG_SCREENFADE = 31;
	REG_MAPSET1 = 0x80;
	REG_INTRMODE |= 0x80;
	clearLevel();
	levelNum = 0;
	cameraX = cameraY = 0;
	loadFromCode(levels[levelNum]);
	lastDir = 2;
	draw();
	DRAW->FadeFromBlack();

	for(;;)
	{
		int in = REG_KEYIN;
		drawPlayer(lastDir);
		while (REG_KEYIN != 0) { drawPlayer(lastDir); }
		switch (in)
		{
			case KEY_LEFT: move(-1, 0); break;
			case KEY_RIGHT: move(1, 0); break;
			case KEY_UP: move(0, -1); break;
			case KEY_DOWN: move(0, 1); break;
			case 0x13:
				DRAW->FadeToWhite();
				levelNum++;
				loadFromCode(levels[levelNum]);
				lastDir = 2;
				cameraX = cameraY = 0;
				draw();
				focus();
				DRAW->FadeFromWhite();
				break;
		}
		if (checkWin())
		{
			DRAW->FadeToWhite();
			levelNum++;
			loadFromCode(levels[levelNum]);
			lastDir = 2;
			cameraX = cameraY = 0;
			draw();
			focus();
			DRAW->FadeFromWhite();
		}
	}
}
